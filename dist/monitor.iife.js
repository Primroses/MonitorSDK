var monitor=function(e){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function t(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function n(i,a,c,s){return new(c=c||Promise)(function(e,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(n,r)}o((s=s.apply(i,a||[])).next())})}function s(n,r){var o,i,a,e,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,i=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){c.label=t[1];break}if(6===t[0]&&c.label<a[1]){c.label=a[1],a=t;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(t);break}a[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var o,i,a,u,d,c=(o=console.log,i=['font-family: "Microsoft YaHei", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";',"color:white;","font-size:12px;","maring:5px 0;","background:yellowgreen;"],a=["color:black;","font-size:12px;"],function(e,t){o.call(o,"%c "+e+" %c "+t,i.join(""),a.join(""))}),l=(g.prototype.set=function(e){this.data=e},g),f=(t(w,d=l),w),p=(t(m,u=l),m),h={headers:{"Content-Type":"application/json"},cache:"force-cache",method:"GET"};function m(e,t,n){var r=u.call(this,e,t)||this,o=n.request,i=n.resourceName,a=n.duration,c=n.redirect,s=n.connect;return r.request=o,r.resourceName=i,r.redirect=c,r.duration=a,r.connect=s,r}function w(e,t,n){var r=d.call(this,e,t)||this,o=n.loadPageTime,i=n.domReady,a=n.redirect,c=n.lookupDomain,s=n.TTFB,u=n.contentReady,l=n.connect;return r.loadPageTime=o,r.domReady=i,r.redirect=a,r.lookupDomain=c,r.TTFB=s,r.contentReady=u,r.connect=l,r}function g(e,t){var n,r,o,i,a;this.type=e,this.userInfo={userId:localStorage.getItem("userId"),userName:localStorage.getItem("userName")},this.info={browser:(o=[(n="undefined"!=typeof window&&window.navigator.userAgent.toLowerCase())&&/msie|trident/.test(n),r=n&&0<n.indexOf("edge/"),n&&/chrome\/\d+/.test(n)&&!r,n&&(-1<n.indexOf("opera")||-1<n.indexOf("opr")),n&&-1<n.indexOf("safari")&&-1===n.indexOf("chrome"),n&&0<n.indexOf("mqqbrowser"),n&&-1<n.indexOf("firefox"),n&&0<n.indexOf("ucbrowser/"),n&&0<n.indexOf("baiduboxapp"),n&&0<n.indexOf("android"),n&&/iphone|ipad|ipod|ios/.test(n)],(i=["IE","Edge","Chrome","Opera","Safari","QQ","FF","UC","Baidu","Android","IOS"].map(function(e){return{type:e,UA:n}}))[a=o.map(function(e,t){if(e)return t}).filter(Boolean)[0]]?i[a]:{type:"unknow",UA:n}),os:function(){var e=navigator.userAgent,t="Win32"==navigator.platform||"Windows"==navigator.platform,n="Mac68K"==navigator.platform||"MacPPC"==navigator.platform||"Macintosh"==navigator.platform||"MacIntel"==navigator.platform;if(n)return"Mac";if("X11"==navigator.platform&&!t&&!n)return"Unix";if(-1<String(navigator.platform).indexOf("Linux"))return"Linux";if(t){if(-1<e.indexOf("Windows NT 5.0")||-1<e.indexOf("Windows 2000"))return"Win2000";if(-1<e.indexOf("Windows NT 5.1")||-1<e.indexOf("Windows XP"))return"WinXP";if(-1<e.indexOf("Windows NT 5.2")||-1<e.indexOf("Windows 2003"))return"Win2003";if(-1<e.indexOf("Windows NT 6.0")||-1<e.indexOf("Windows Vista"))return"WinVista";if(-1<e.indexOf("Windows NT 6.1")||-1<e.indexOf("Windows 7"))return"Win7";if(-1<e.indexOf("Windows NT 10")||-1<e.indexOf("Windows 10"))return"Win10"}return"other"}()},this.time=(new Date).toLocaleString(),this.appId=1001,this.target=t}function v(i,a,c){return void 0===c&&(c="GET"),n(this,void 0,void 0,function(){var t,n,r,o;return s(this,function(e){switch(e.label){case 0:c=c.toUpperCase(),a="http://localhost:3000/record"+a,"GET"===c&&(t="",Object.keys(i).forEach(function(e){t+=e+"="+i[e]+"&"}),""!==t&&(t=t.substr(0,t.lastIndexOf("&")),a=a+"?"+t)),"POST"!==c&&"PUT"!==c&&"DELETE"!==c||(Object.defineProperty(h,"body",{value:JSON.stringify(i),configurable:!0,enumerable:!0}),h.method=c),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,fetch(a,h)];case 2:return r=e.sent(),n=r.json(),[3,4];case 3:return o=e.sent(),n=o,[3,4];case 4:return[2,n]}})})}var y=(x.prototype.push=function(r){return n(this,void 0,void 0,function(){var t,n;return s(this,function(e){switch(e.label){case 0:return"error"!==(t=this.type.toLowerCase())?[3,2]:[4,v(r,"/error","POST")];case 1:return e.sent(),[3,7];case 2:return"performance"!==t?[3,4]:[4,v(r,"/performance","POST")];case 3:return e.sent(),[3,7];case 4:return"resource"!==t?[3,6]:(console.log(r),[4,v(r,"/resource","POST")]);case 5:return e.sent(),[3,7];case 6:"track"===t&&(n=localStorage.getItem(t)||"",localStorage.setItem(t,n+"| "+JSON.stringify(r))),e.label=7;case 7:return[2]}})})},x),O=new y("ERROR"),S=new y("TRACK"),E=new y("PERFORMANCE"),T=new y("RESOURCE");function x(e){this.type=e}function b(e,t,n,r){var o=new l(e,r);o.set(t),n.push(o)}return e.initMonitor=function(){var t;window.addEventListener("error",function(e){if(e.cancelable){var t=e.lineno,n=e.filename,r=e.timeStamp,o=e.error;b("ERROR",{lineno:t,filename:n,timeStamp:r,message:o.message,stack:o.stack},O,"script")}else{var i=e.target,a=i.localName,c=i.href,s=i.src;b("RESOURCE",{resourceType:a,sourceUrl:"link"===a?c:s},O,"resource")}},!0),window.addEventListener("unhandledrejection",function(e){b("PROMISE",{reason:e.reason,timeStamp:e.timeStamp},O,"promise")}),function(e){if(void 0===e&&(e="SPA"),"SPA"!==e){var t=window.open;window.open=function(){return b("TRACK",{url:window.location.href},S,"open"),t&&t.apply(this,arguments)}}else["pushState","replaceState"].forEach(function(e){var n=history[e];history[e]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return b("TRACK",{url:e[2]},S,"history"),n&&n.apply(this,e)}}),window.onhashchange=function(){b("TRACK",{url:window.location.hash.substr(-1)},S,"hashChange")}}(),function(){var r=new l("AJAX","Fetch"),o=window.fetch;window.fetch=function(e,t){var n={input:e,init:t};return r.set(n),S.push(r),o&&o.call(this,e,t)};var i=new l("AJAX","ajax"),a=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){var n={method:e,url:t};return i.set(n),a&&a.call(this,e,t)};var t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(e){return console.log(e),i.set(e),t&&t.call(this,e)},S.push(i)}(),window.addEventListener("click",function(e){var t=e.path[0];[document.getElementsByTagName("body")[0],document.getElementsByTagName("html")[0],document].includes(t)||(console.log(e.path,t.outerHTML),b("EVENT",{target:t.outerHTML},S,"click"))},!0),function(){var e=window.performance;if(e)var o=e.timing,i=setInterval(function(){if(0!==o.loadEventEnd){clearInterval(i),i=null;var e={};e.loadPageTime=o.loadEventEnd-o.navigationStart,e.domReady=o.domComplete-o.responseEnd,e.redirect=o.redirectEnd-o.redirectStart,e.lookupDomain=o.domainLookupEnd-o.domainLookupStart,e.TTFB=o.responseStart-o.navigationStart,e.contentReady=o.responseEnd-o.requestStart,e.connect=o.connectEnd-o.connectStart;var t=new f("PERFORMANCE","window",e);E.push(t),n=["link","script","img"],r=window.performance.getEntriesByType("resource").map(function(e){if(-1<n.indexOf(e.initiatorType)){var t={};return t.resourceName=e.name.substr(e.name.lastIndexOf("/")+1),t.duration=e.duration,t.request=e.responseEnd-e.requestStart,t.redirect=e.redirectEnd-e.redirectStart,t.connect=e.connectEnd-e.connectStart,new p("RESOURCE",e.initiatorType,t)}}).filter(Boolean),T.push(r)}var n,r},10);else console.log("你的浏览器不支持 performance 接口")}(),t=localStorage.getItem("track").split("|").filter(Boolean).map(JSON.parse),localStorage.setItem("track",""),t=t.map(function(e){return!(e.data&&e.data.input&&e.data.input.includes("record"))&&!(e.data&&e.data.url&&e.data.url.includes("record"))&&!!e.data&&e}).filter(Boolean),console.log(t),window.addEventListener("beforeunload",function(){if(navigator.sendBeacon)navigator.sendBeacon("http://localhost:3000/record/track",JSON.stringify(t));else{var e=new XMLHttpRequest;e.open("POST","http://localhost:3000/record/track",!1),e.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),e.send(JSON.stringify(t))}}),c("[ MonitorSDK ]","Starting Monitor")},e}({});
