!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).index={})}(this,(function(e){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(a,s)}c((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function i(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}function s(e){["error","warn"].forEach((function(t){var n=console[t];console[t]=function(t){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];var i=Object.assign(e.data(),{mainType:"CONSOLE",data:JSON.stringify({message:t})});return e.addIndexDB(i),n.call.apply(n,a([n,t],r))}}))}function c(e){window.addEventListener("error",(function(t){var r;if(t.cancelable){var o=t.lineno,i=t.filename,a=(t.timeStamp,t.error);r={lineno:o,filename:i,message:a?a.message:t.message,stack:a?a.stack:""}}else{var s=t.target,c=s.localName,u=s.href,d=s.src;r={resourceType:c,sourceUrl:"link"===c?u:d}}var f=Object.assign(e.data(),{mainType:r.resourceType?"RESOURCE":"ERROR",data:JSON.stringify(r)});e.request(n(n({},f),{tableName:"error"}),"/error")}),!0)}function u(e){var t=function(e,t,n){return n?t?t||n?"["+e.toLowerCase()+"][id="+t+"][class="+n.split(" ")+"]":""+e.toLowerCase():e.toLowerCase()+"."+n.split(" ").join("."):e.toLowerCase()+"#"+t};["click","input"].forEach((function(n){window.addEventListener(n,(function(n){var r=n.target,o=r.tagName,i=r.id,a=r.className,s=r.outerHTML;if("HTML"!=o){var c={trackTarget:t(o,i,a),trackType:n.type,trackContent:s},u=Object.assign(e.data(),{mainType:"EVENT",data:JSON.stringify(c)});e.addIndexDB(u,"track")}}))}),!0)}function d(e){window.addEventListener("unhandledrejection",(function(t){var r={reason:t.reason},o=Object.assign(e.data(),{mainType:"PROMISE",data:JSON.stringify({reason:r.reason})});e.request(n(n({},o),{tableName:"error"}),"/error")}))}function f(e){!function(e){var t=["login","register"],r=0,o=new Map,i=XMLHttpRequest.prototype.open,a=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,n){if(t.indexOf(n)<0){var a={method:e,url:n};o.set(r,a)}return i&&i.call(this,e,n)},XMLHttpRequest.prototype.send=function(t){var i=o.get(r),s=Object.assign(e.data(),{mainType:"REQUEST",data:n(n({},i),{body:t,requestType:"AJAX"})});return e.addIndexDB(s,"track"),r+=1,a&&a.call(this,t)}}(e),function(e){var t=this,n=window.fetch;window.fetch=function(r,o){var i=Object.assign(e.data(),{mainType:"REQUEST",data:JSON.stringify({input:r,init:o,requestType:"FETCH"})});return e.addIndexDB(i,"track"),n&&n.call(t,r,o)}}(e)}function p(e){!function(e){["pushState","replaceState"].forEach((function(t){var n=window.history[t];window.history[t]=function(r,o,i){var a=Object.assign(e.data(),{mainType:"ROUTE",data:JSON.stringify({routeData:r,title:o,url:i,routeType:t})});return e.addIndexDB(a,"track"),n&&n.call(this,r,o,i)}}))}(e),function(e){var t=window.onhashchange;window.onhashchange=function(n){var r="/"+window.location.hash.substr(1),o=Object.assign(e.data(),{mainType:"ROUTE",data:JSON.stringify({url:r,routeType:"Hash"})});return e.addIndexDB(o,"track"),t&&t.call(this,n)}}(e)}function l(e){if(!window.performance)return console.error("[ MonitorSDK ] This browser does not support performance"),!1;var t=window.performance.timing;if(t)var n=setInterval((function(){if(t.loadEventEnd){var r={loadPageTime:t.loadEventEnd-t.navigationStart,domReady:t.domComplete-t.responseEnd,redirect:t.redirectEnd-t.redirectStart,lookupDomain:t.domainLookupEnd-t.domainLookupStart,TTFB:t.responseStart-t.navigationStart,contentReady:t.responseEnd-t.requestStart,connect:t.connectEnd-t.connectStart},o=Object.assign(e.data(),{mainType:"Performance",data:JSON.stringify(r)});e.addIndexDB(o,"performance"),clearInterval(n),n=null}}),1e3);!function(e){var t=["link","script","img"],n=window.performance.getEntriesByType("resource").map((function(e){if(t.indexOf(e.initiatorType)>-1)return{name:e.name.substr(e.name.lastIndexOf("/")+1),duration:e.duration,request:e.responseEnd-e.requestStart,redirect:e.redirectEnd-e.redirectStart,connect:e.connectEnd-e.connectStart}})).filter(Boolean),r=Object.assign(e.data(),{mainType:"Performance",data:JSON.stringify(n)});e.addIndexDB(r,"performance")}(e)}function m(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){return t=window.addEventListener,window.addEventListener=function(n,r,o){return t.call(this,n,(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{return r.apply(this,t)}catch(t){if(t){var o=Object.assign(e.data(),{mainType:"EVENTLISTENER",data:JSON.stringify({message:t.message,stack:t.stack}),eventType:t.name});e.addIndexDB(o)}}}),o)},[2]}))}))}function y(e){var t="monitor-click";window.addEventListener("click",(function(e){var n=e.target;Array.from(document.querySelectorAll("."+t));if(n.className.indexOf(t)>-1){var r=n.getAttribute("data-click");console.log("[Monitor-Click]",n,r)}})),window.onload=function(){!function(e){var t=(new Date).toLocaleDateString();t=t.indexOf("/")?t.replace(/(\/)/g,""):t.replace(/-/g,"");var n=e.store.get("PV");if(n&&"undefined"!==n){var r=JSON.parse(n),o=r.date,i=r.pv;o===t&&(i+=1,e.store.set("PV",JSON.stringify({date:o,pv:i})))}else{var a={date:t,pv:1};e.store.set("PV",JSON.stringify(a))}}(e)}}function g(){var e=navigator.userAgent,t="Win32"==navigator.platform||"Windows"==navigator.platform,n="Mac68K"==navigator.platform||"MacPPC"==navigator.platform||"Macintosh"==navigator.platform||"MacIntel"==navigator.platform;if(n)return"Mac";if("X11"==navigator.platform&&!t&&!n)return"Unix";if(String(navigator.platform).indexOf("Linux")>-1)return"Linux";if(t){if(e.indexOf("Windows NT 5.0")>-1||e.indexOf("Windows 2000")>-1)return"Win2000";if(e.indexOf("Windows NT 5.1")>-1||e.indexOf("Windows XP")>-1)return"WinXP";if(e.indexOf("Windows NT 5.2")>-1||e.indexOf("Windows 2003")>-1)return"Win2003";if(e.indexOf("Windows NT 6.0")>-1||e.indexOf("Windows Vista")>-1)return"WinVista";if(e.indexOf("Windows NT 6.1")>-1||e.indexOf("Windows 7")>-1)return"Win7";if(e.indexOf("Windows NT 10")>-1||e.indexOf("Windows 10")>-1)return"Win10"}return"other"}var v,h,w,O=(v=console.log,h=['font-family: "Microsoft YaHei", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";',"color:white;","font-size:12px;","maring:5px 0;","background:yellowgreen;"],w=["color:black;","font-size:12px;"],function(e,t){v.call(v,"%c "+e+" %c "+t,h.join(""),w.join(""))});function b(e,t){if(void 0===t&&(t=new Map),"object"==typeof e){if(t.has(e))return t.get(e);var n=Array.isArray(e)?[]:{};for(var r in t.set(e,n),e)n[r]="object"==typeof e[r]?b(e[r],t):e[r];return n}}var S=function(){function e(e,t){void 0===t&&(t=1),this.DBRequest=indexedDB.open(e,t),this.DBRequest.onerror=function(){},this.DBRequest.onsuccess=function(){},this.DBRequest.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains("error")||t.createObjectStore("error",{keyPath:"errorId",autoIncrement:!0}).createIndex("mainType","mainType");t.objectStoreNames.contains("track")||t.createObjectStore("track",{keyPath:"pathId",autoIncrement:!0}).createIndex("mainType","mainType");t.objectStoreNames.contains("performance")||t.createObjectStore("performance",{keyPath:"performanceId",autoIncrement:!0}).createIndex("mainType","mainType")}}return e.prototype.DBResolve=function(){var e=this;return new Promise((function(t,n){e.DBRequest.addEventListener("success",(function(){t(e.DBRequest.result)}))}))},e.prototype.add=function(e,t,n){return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){return r=e.transaction([t],"readwrite").objectStore(t).add(n),[2,new Promise((function(e,t){r.addEventListener("success",(function(t){e(t)})),r.addEventListener("error",(function(e){t(e)}))}))]}))}))},e.prototype.read=function(e,t,n){return r(this,void 0,void 0,(function(){var r,i,a;return o(this,(function(o){return r=[],i=e.transaction([t]).objectStore(t),n?(a=i.index("mainType").get(n),[2,new Promise((function(e,t){a.addEventListener("success",(function(t){var n=t.target.result;e(n)})),i.openCursor().addEventListener("error",(function(e){t(e)}))}))]):[2,new Promise((function(e,t){i.openCursor().addEventListener("success",(function(t){var n=t.target.result;n?(r.push(n.value),n.continue()):e(r)})),i.openCursor().addEventListener("error",(function(e){t(e)}))}))]}))}))},e.prototype.clear=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){return n=e.transaction([t],"readwrite").objectStore(t),[2,new Promise((function(e){e(n.clear())}))]}))}))},e}(),T=new(function(){function e(){}return e.prototype.remove=function(e){localStorage.removeItem(e)},e.prototype.set=function(e,t){localStorage.setItem(e,t)},e.prototype.get=function(e){return localStorage.getItem(e)},e}()),x=function(e){this.userId=e.userId,this.trackId=e.trackId,this.timeStamp=e.timeStamp,this.mainType=e.mainType,this.device=e.device,this.currentUrl=e.currentUrl,this.refererUrl=e.refererUrl,this.pageInfo=e.pageInfo,this.appVersion=e.appVersion,this.apiVersion=e.apiVersion,this.appId=e.appId,this.data=e.data},E=(function(e){function n(t){var n=e.call(this,t)||this;return n.navigation=t.navigation,n.timesData=t.timesData,n.timesResource=t.timesResource,n.memoryInfo=t.memoryInfo,n}(function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)})(n,e)}(x),new(function(){function e(){this.worker=new Worker("./worker.js"),this.messageQuene=[],this.store=T}return e.prototype.sentMessageToWorker=function(e){var t=this;this.success?(this.messageQuene.length&&(this.messageQuene.forEach((function(e){t.worker.postMessage(JSON.stringify(e))})),this.messageQuene=[]),t.worker.postMessage(JSON.stringify(e))):this.messageQuene.push(e)},e.prototype.acceptMessageFromWorker=function(e,t){var r=this,o=this;this.worker.addEventListener("message",(function(i){var a=JSON.parse(i.data),s=a.saveType,c=a.acceptLastVisited,u=a.data,d=a.tableName;if(a.success){r.success=!0;var f=e.store.get("LastVisited");e.sentMessageToWorker({saveType:"store",data:{LastVisited:f}})}"store"===s?o.store.set("LastVisited",c):"indexDB"===s&&t(n(n({},u),{tableName:d}),"/error")})),this.worker.addEventListener("messageerror",(function(e){}))},e.prototype.add=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e.prototype.read=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e.prototype.clear=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e}()));e.initMonitor=function(e){var t,n,r,o,i,a,v,h=new S("monitor"),w=e.baseUrl,k=e.userId,I=new x({userId:k,trackId:(v=Date.now().toString(36),v+=Math.random().toString(36).substr(3)),device:{os:g(),browser:(t="undefined"!=typeof window&&window.navigator.userAgent.toLowerCase(),n=t&&/msie|trident/.test(t),r=t&&t.indexOf("edge/")>0,o=[n,r,t&&/chrome\/\d+/.test(t)&&!r,t&&(t.indexOf("opera")>-1||t.indexOf("opr")>-1),t&&t.indexOf("safari")>-1&&-1===t.indexOf("chrome"),t&&t.indexOf("mqqbrowser")>0,t&&t.indexOf("firefox")>-1,t&&t.indexOf("ucbrowser/")>0,t&&t.indexOf("baiduboxapp")>0,t&&t.indexOf("android")>0,t&&/iphone|ipad|ipod|ios/.test(t)],i=["IE","Edge","Chrome","Opera","Safari","QQ","FF","UC","Baidu","Android","IOS"].map((function(e){return{type:e,ua:t}})),a=o.map((function(e,t){if(e)return t})).filter(Boolean)[0],i[a]?i[a]:{type:"unknow",ua:t})},appVersion:1,apiVersion:1,appId:1,pageInfo:{pageWidth:document.body?document.body.clientWidth:0,pageHeight:document.body?document.body.clientHeight:0,screenWidth:window.screen.width||0,screenHeight:window.screen.height||0},currentUrl:window.location.href,refererUrl:document.referrer||"/",timeStamp:(new Date).toString()}),j=function(e,t){!function(e){new Image(1,1).src=e}(function(e,t){var n=t+"/abc.jpg?";return function e(t){Object.keys(t).forEach((function(r){"[object Object]"===Object.prototype.toString.call(t[r])?e(t[r]):n+=r+"="+t[r]+"&"}))}(e),n=n.substring(n.lastIndexOf("&"),-1)}(e,w+t))},N={db:h,data:function(){return b(I)},request:j,worker:E,addIndexDB:function(e,t,n){return void 0===t&&(t="error"),void 0===n&&(n="add"),E.add("indexDB",{operatorType:n,tableName:t,data:e})},store:T};!function(e){E.acceptMessageFromWorker(E,e)}(j);for(var L=[m,l,s,c,u,d,f,p,y],M=0;M<L.length;M++)L[M](N);return O("[ MonitorSDK ]","Starting Monitor"),{req:j}},Object.defineProperty(e,"__esModule",{value:!0})}));
