!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).index={})}(this,(function(e){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(a,s)}c((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function i(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}function s(e){["error","warn"].forEach((function(t){var n=console[t];console[t]=function(t){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];var i=Object.assign(e.data(),{mainType:"CONSOLE",data:JSON.stringify({message:t})});return e.addIndexDB(i),n.call.apply(n,a([n,t],r))}}))}function c(e){window.addEventListener("error",(function(t){var r;if(t.cancelable){var o=t.lineno,i=t.filename,a=(t.timeStamp,t.error);r={lineno:o,filename:i,message:a?a.message:t.message,stack:a?a.stack:""}}else{var s=t.target,c=s.localName,u=s.href,d=s.src;r={resourceType:c,sourceUrl:"link"===c?u:d}}var f=Object.assign(e.data(),{mainType:r.resourceType?"RESOURCE":"ERROR",data:JSON.stringify(r)});e.request(n(n({},f),{tableName:"error"}),"/error")}),!0)}function u(e){var t=function(e,t,n){return!n&&t?e.toLowerCase()+"[id="+t+"]":!t&&n?e.toLowerCase()+"[class="+n.split(" ")+"]":t||n?"["+e.toLowerCase()+"][id="+t+"][class="+n.split(" ")+"]":""+e.toLowerCase()};["click","input"].forEach((function(n){window.addEventListener(n,(function(n){var r=n.target,o=r.tagName,i=r.id,a=r.className,s=r.outerHTML;if("HTML"!=o&&"BODY"!=o){var c={trackTarget:t(o,i,a),trackType:n.type,trackContent:s},u=Object.assign(e.data(),{mainType:"EVENT",data:JSON.stringify(c)});e.addIndexDB(u,"track")}}))}),!0)}function d(e){window.addEventListener("unhandledrejection",(function(t){var r={reason:t.reason},o=Object.assign(e.data(),{mainType:"PROMISE",data:JSON.stringify({reason:r.reason})});e.request(n(n({},o),{tableName:"error"}),"/error")}))}function f(e){!function(e){var t=0,r=new Map,o=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,n){var i={method:e,url:n};return r.set(t,i),o&&o.call(this,e,n)},XMLHttpRequest.prototype.send=function(o){var a=r.get(t),s=Object.assign(e.data(),{mainType:"REQUEST",data:n(n({},a),{body:o,requestType:"AJAX"})});return e.addIndexDB(s,"track"),t+=1,i&&i.call(this,o)}}(e),function(e){var t=this,n=window.fetch;window.fetch=function(r,o){if(e.filterUrl.every((function(e){return r.indexOf(e)<0}))){var i=Object.assign(e.data(),{mainType:"REQUEST",data:JSON.stringify({input:r,init:o,requestType:"FETCH"})});e.addIndexDB(i,"track")}return n&&n.call(t,r,o)}}(e)}function l(e){!function(e){["pushState","replaceState"].forEach((function(t){var n=window.history[t];window.history[t]=function(r,o,i){var a=Object.assign(e.data(),{mainType:"ROUTE",data:JSON.stringify({routeData:r,title:o,url:i,routeType:t})});return e.addIndexDB(a,"track"),n&&n.call(this,r,o,i)}}))}(e),function(e){var t=window.onhashchange;window.onhashchange=function(n){var r="/"+window.location.hash.substr(1),o=Object.assign(e.data(),{mainType:"ROUTE",data:JSON.stringify({url:r,routeType:"Hash"})});return e.addIndexDB(o,"track"),t&&t.call(this,n)}}(e)}var p=new(function(){function e(){this.channel=new Map,this.channel.set("MAIN",[]),this.channel.set("WORKER",[]),this.channel.set("IDLE",[])}return e.prototype.subscribe=function(e,t){this.channel.get(e).push(t)},e.prototype.publish=function(e){this.channel.get(e).forEach((function(e){e()}))},e}());function h(e){if(!window.performance)return console.error("[ MonitorSDK ] This browser does not support performance"),!1;var t=window.performance.timing;if(t)var n=setInterval((function(){if(t.loadEventEnd){var r={loadPageTime:t.loadEventEnd-t.navigationStart,domReady:t.domComplete-t.responseEnd,redirect:t.redirectEnd-t.redirectStart,lookupDomain:t.domainLookupEnd-t.domainLookupStart,TTFB:t.responseStart-t.navigationStart,contentReady:t.responseEnd-t.requestStart,connect:t.connectEnd-t.connectStart},o=Object.assign(e.data(),{mainType:"Performance",data:JSON.stringify(r)});e.addIndexDB(o,"performance"),p.publish("IDLE"),clearInterval(n),n=null}}),1e3);!function(e){var t=["link","script","img"],n=window.performance.getEntriesByType("resource").map((function(e){if(t.indexOf(e.initiatorType)>-1)return{name:e.name.substr(e.name.lastIndexOf("/")+1),duration:e.duration,request:e.responseEnd-e.requestStart,redirect:e.redirectEnd-e.redirectStart,connect:e.connectEnd-e.connectStart}})).filter(Boolean),r=Object.assign(e.data(),{mainType:"Performance",data:JSON.stringify(n)});e.addIndexDB(r,"performance")}(e)}function g(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){return t=window.addEventListener,window.addEventListener=function(n,r,o){return t.call(this,n,(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{return r.apply(this,t)}catch(t){if(t){var o=Object.assign(e.data(),{mainType:"EVENTLISTENER",data:JSON.stringify({message:t.message,stack:t.stack}),eventType:t.name});e.addIndexDB(o)}}}),o)},[2]}))}))}function y(e){var t="monitor-click";window.addEventListener("click",(function(n){var r=n.target;Array.from(document.querySelectorAll("."+t));if(r.className.indexOf(t)>-1){var o=r.getAttribute("data-click"),i=Object.assign(e.data(),{mainType:"PROMISE",data:JSON.stringify({target:r,attr:o})});e.addIndexDB(i,"track")}})),window.onload=function(){!function(e){var t=(new Date).toLocaleDateString(),n={date:t=t.indexOf("/")?t.replace(/(\/)/g,""):t.replace(/-/g,"")},r=e.store.get("PV");if(r&&"undefined"!==r){var o=JSON.parse(r),i=o.date,a=o.pv;i===t&&(a+=1,e.store.set("PV",JSON.stringify({date:i,pv:a})))}else{var s=Object.assign(n,{pv:1});e.store.set("PV",JSON.stringify(s))}}(e)}}function v(){var e=navigator.userAgent,t="Win32"==navigator.platform||"Windows"==navigator.platform,n="Mac68K"==navigator.platform||"MacPPC"==navigator.platform||"Macintosh"==navigator.platform||"MacIntel"==navigator.platform;if(n)return"Mac";if("X11"==navigator.platform&&!t&&!n)return"Unix";if(String(navigator.platform).indexOf("Linux")>-1)return"Linux";if(t){if(e.indexOf("Windows NT 5.0")>-1||e.indexOf("Windows 2000")>-1)return"Win2000";if(e.indexOf("Windows NT 5.1")>-1||e.indexOf("Windows XP")>-1)return"WinXP";if(e.indexOf("Windows NT 5.2")>-1||e.indexOf("Windows 2003")>-1)return"Win2003";if(e.indexOf("Windows NT 6.0")>-1||e.indexOf("Windows Vista")>-1)return"WinVista";if(e.indexOf("Windows NT 6.1")>-1||e.indexOf("Windows 7")>-1)return"Win7";if(e.indexOf("Windows NT 10")>-1||e.indexOf("Windows 10")>-1)return"Win10"}return"other"}var m,w,O,b=(m=console.log,w=['font-family: "Microsoft YaHei", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";',"color:white;","font-size:12px;","maring:5px 0;","background:yellowgreen;"],O=["color:black;","font-size:12px;"],function(e,t){m.call(m,"%c "+e+" %c "+t,w.join(""),O.join(""))});function S(e,t){if(void 0===t&&(t=new Map),"object"==typeof e){if(t.has(e))return t.get(e);var n=Array.isArray(e)?[]:{};for(var r in t.set(e,n),e)n[r]="object"==typeof e[r]?S(e[r],t):e[r];return n}}function x(e){return e.reduce((function(e,t){return Array.isArray(t)?e.concat(x(t)):e.concat(t)}),[])}var E=function(){function e(e,t){void 0===t&&(t=1),this.DBRequest=indexedDB.open(e,t),this.DBRequest.onerror=function(){},this.DBRequest.onsuccess=function(){},this.DBRequest.onupgradeneeded=function(e){var t,n,r=e.target.result;try{for(var o=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(["error","track","performance"]),i=o.next();!i.done;i=o.next()){var a=i.value;if(!r.objectStoreNames.contains(a))r.createObjectStore(a,{keyPath:"track"===a?"pathId":a+"Id",autoIncrement:!0})}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}}}return e.prototype.DBResolve=function(){var e=this;return new Promise((function(t,n){e.DBRequest.addEventListener("success",(function(){t(e.DBRequest.result)}))}))},e.prototype.add=function(e,t,n){return r(this,void 0,void 0,(function(){var r;return o(this,(function(o){return r=e.transaction([t],"readwrite").objectStore(t).add(n),[2,new Promise((function(e,t){r.addEventListener("success",(function(t){e(t)})),r.addEventListener("error",(function(e){t(e)}))}))]}))}))},e.prototype.read=function(e,t,n){return r(this,void 0,void 0,(function(){var r,i,a;return o(this,(function(o){return r=[],i=e.transaction([t]).objectStore(t),n?(a=i.index("mainType").get(n),[2,new Promise((function(e,t){a.addEventListener("success",(function(t){var n=t.target.result;e(n)})),i.openCursor().addEventListener("error",(function(e){t(e)}))}))]):[2,new Promise((function(e,t){i.openCursor().addEventListener("success",(function(t){var n=t.target.result;n?(r.push(n.value),n.continue()):e(r)})),i.openCursor().addEventListener("error",(function(e){t(e)}))}))]}))}))},e.prototype.clear=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){return n=e.transaction([t],"readwrite").objectStore(t),[2,new Promise((function(e){e(n.clear())}))]}))}))},e}(),T=new(function(){function e(){}return e.prototype.remove=function(e){localStorage.removeItem(e)},e.prototype.set=function(e,t){localStorage.setItem(e,t)},e.prototype.get=function(e){return localStorage.getItem(e)},e}()),k=function(e){this.userId=e.userId,this.trackId=e.trackId,this.timeStamp=e.timeStamp,this.mainType=e.mainType,this.device=e.device,this.currentUrl=e.currentUrl,this.refererUrl=e.refererUrl,this.pageInfo=e.pageInfo,this.appVersion=e.appVersion,this.apiVersion=e.apiVersion,this.appId=e.appId,this.data=e.data},I=(function(e){function n(t){var n=e.call(this,t)||this;return n.navigation=t.navigation,n.timesData=t.timesData,n.timesResource=t.timesResource,n.memoryInfo=t.memoryInfo,n}(function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)})(n,e)}(k),new(function(){function e(){this.worker=new Worker("./worker.js"),this.messageQuene=[],this.store=T}return e.prototype.sentMessageToWorker=function(e){var t=this;this.success?(this.messageQuene.length&&(this.messageQuene.forEach((function(e){t.worker.postMessage(JSON.stringify(e))})),this.messageQuene=[]),t.worker.postMessage(JSON.stringify(e))):this.messageQuene.push(e)},e.prototype.acceptMessageFromWorker=function(e,t,n){var r=this,o=this;this.worker.addEventListener("message",(function(t){var i=JSON.parse(t.data),a=i.saveType,s=i.acceptLastVisited,c=i.data;if(i.success){r.success=!0;var u=e.store.get("LastVisited");e.sentMessageToWorker({saveType:"store",data:{LastVisited:u}})}if("store"===a)o.store.set("LastVisited",s);else if("indexDB"===a){var d=x(c);n(d,"/postError")}})),this.worker.addEventListener("messageerror",(function(e){}))},e.prototype.add=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e.prototype.read=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e.prototype.clear=function(e,t){this.sentMessageToWorker({saveType:e,data:t})},e}()));e.initMonitor=function(e){var t,n,r,o,i,a,m,w=new E("monitor"),O=e.baseUrl,x=e.userId,j=e.Vue,L=new k({userId:x,trackId:(m=Date.now().toString(36),m+=Math.random().toString(36).substr(3)),device:{os:v(),browser:(t="undefined"!=typeof window&&window.navigator.userAgent.toLowerCase(),n=t&&/msie|trident/.test(t),r=t&&t.indexOf("edge/")>0,o=[n,r,t&&/chrome\/\d+/.test(t)&&!r,t&&(t.indexOf("opera")>-1||t.indexOf("opr")>-1),t&&t.indexOf("safari")>-1&&-1===t.indexOf("chrome"),t&&t.indexOf("mqqbrowser")>0,t&&t.indexOf("firefox")>-1,t&&t.indexOf("ucbrowser/")>0,t&&t.indexOf("baiduboxapp")>0,t&&t.indexOf("android")>0,t&&/iphone|ipad|ipod|ios/.test(t)],i=["IE","Edge","Chrome","Opera","Safari","QQ","FF","UC","Baidu","Android","IOS"].map((function(e){return{type:e,ua:t}})),a=o.map((function(e,t){if(e)return t})).filter(Boolean)[0],i[a]?i[a]:{type:"unknow",ua:t})},appVersion:1,apiVersion:1,appId:1,pageInfo:{pageWidth:document.body?document.body.clientWidth:0,pageHeight:document.body?document.body.clientHeight:0,screenWidth:window.screen.width||0,screenHeight:window.screen.height||0},currentUrl:window.location.href,refererUrl:document.referrer||"/",timeStamp:(new Date).toString()}),N=function(e,t){!function(e){new Image(1,1).src=e}(function(e,t){var n=t+"/abc.jpg?";return function e(t){Object.keys(t).forEach((function(r){"[object Object]"===Object.prototype.toString.call(t[r])?e(t[r]):n+=r+"="+t[r]+"&"}))}(e),n=n.substring(n.lastIndexOf("&"),-1)}(e,O+t))},D={db:w,data:function(){return S(L)},request:N,worker:I,addIndexDB:function(e,t,n){return void 0===t&&(t="error"),void 0===n&&(n="add"),I.add("indexDB",{operatorType:n,tableName:t,data:e})},store:T,filterUrl:["login","register","postError","sockjs-node"]};!function(e,t){I.acceptMessageFromWorker(I,e,t),p.subscribe("IDLE",(function(){window.requestIdleCallback?window.requestIdleCallback((function(){console.log("idle"),I.worker.postMessage(JSON.stringify({idle:!0}))})):I.worker.postMessage(JSON.stringify({idle:!0}))}))}(N,(function(e,t){!function(e,t){var n={method:"POST",headers:{"Content-Type":"application/json"},cache:"force-cache"};Object.defineProperty(n,"body",{value:JSON.stringify(e)});try{fetch(t,n)}catch(e){console.error(e)}}(e,O+t)}));for(var M=[g,h,s,c,u,d,f,l,y],W=0;W<M.length;W++)M[W](D);return function(e,t){console.log("patchVue",t),t.config.errorHandler=function(e,t,n){console.log("Error: "+e.toString()+"\nInfo: "+n)}}(0,j),b("[ MonitorSDK ]","Starting Monitor"),{getReq:N}},Object.defineProperty(e,"__esModule",{value:!0})}));
