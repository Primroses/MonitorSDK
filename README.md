# 前端业务中简单的监控 SDK 实现

先说明一下:只是一个简单的SDK，更多的是为了给大家有一个监控的方向，有一个对产品监控的意思，捕获运行时的错误是很有必要的

## 为什么要自研监控 SDK

- 社区活跃的 Sentry fundeg 等都是优秀的开源项目，但是并不能针对公司内部的项目进行深度的定制化，假如后续监控系统需要跟其他系统结合，自研系统更容易集成，但开源就可能需要大费周章了。
- 自研可以根据实际情况进行一些调整，不需要完全照搬。自己可以针对性的进行数据的调整，整合以及优化等
- 更多的监控系统都是要收费的。。

## 监控上报的数据有什么

1. 用户信息(用户 ID,用户名，唯一可以确定的用户信息，sessionId，cookie 等等)
2. 设备信息(什么浏览器 操作系统 App 版本号)
3. 行为数据(用户访问来源,用户访问路径,用户点击滑动区域等)
4. 性能数据(更好的做性能优化的，脚本加载时间，接口响应时间等)
5. 异常数据(前端脚本加载错误，脚本运行错误)
6. 后端 API 请求超时，返回数据异常，参数交互错误等
7. 定制的活动数据

## 整个监控SDK的架构

## 实现的功能有

1. [√]基于TypeScript的类型检查
2. [√]PV,UV的简单记录
3. [√]Error和Promise的拦截
4. [√]ajax 和 fetch的拦截
5. [√]自定义性能指标
6. [√]自定义上报数据
7. [X]没有一个直观的可视化后台
8. [X]架构方面可能需要进一步的完善
9. [X]暂时只实现Web，还有小程序和Native需要集成  
   [X]前端框架也没有集成(Vue,React,Angular等)
   [X]缺少单元测试

## 监控错误的原理是什么

### 异常类型

| 异常类型           | 同步方法 | 异步方法 |      资源加载       | Promise | async/await |
| ------------------ | :------: | :------: | :-----------------: | :-----: | :---------: |
| try/catch          |    √     |          |                     |         |      √      |
| onError            |    √     |    √     |                     |         |
| Error 事件         |    √     |    √     | √(捕获阶段可以捕获) |         |
| unhandledrejection |          |          |                     |    √    |      √      |

## 性能合适的指标

1. 页面加载时长:Page Load Time PLT
2. 首屏加载时长:Above the fold Time AFT
3. 首次渲染时长:First Paint
4. 首次内容渲染时长: First Contentful Paint
5. 首次有效内容渲染时长: First Meaningful Paint
6. 开始渲染 start Render

## 上报策略

可以根据实际需要调整上报的策略

1. Error 类型的 Data(Error,Promise)等需要实时报警的数据 出现马上上报
2. Track 类型的数据 等用户关闭一并上报(track,Ajax,click)
3. 性能类型的数据(Performance)等 window 完全加载完后延迟 5 秒上报(不妨碍主线程渲染的情况下)

## 对于开发过程中的一些思考

- (1)使用localStorage还是IndexedDB

- (2)定制什么类型的数据

- (3)上报的机制

```JavaScript
/**
 *
 * 覆写window.onerror / unhandledrejection / 还有在Ajax中加入监控 覆写send 和 open方法
 * 记录页面路径一个用户走过的路径
 *
 *
 * 强制上报(可以对性能 资源数据马上能检测的实时数据) / 定期上报(7天 然后整合?) / 及时上报
 *
 * 是否需要IndexDB?
 * 使用场景中单独存放用户的路径和用户所点击的地方 这些数据假如使用localStorage 存 好像不太方便?
 * 第一 场景中存到本地只有track 还有 ajax请求的请求 场景没有覆盖广泛 大多需要及时上报
 * 第二 IndexDB是异步的 假如是上报的时候需要同步发送的时候 就无法及时发送了
 * 第三 localstroage 可以通过简单的处理实现
 *
 * */
```